# This is a prototype and it has shortcomings
#  - Do not re-install prometheus if it already exists
#  - Needs proper Grafana authentication (proper password not stored as plaintext)
#  - Plenty of variable extraction that could occur
#  - Should look at Prometheus tgroups so each metrics endpoint deploys own config
#  - All sorts of security holes would need tightening up
#  - Should use a database other than SQLite for Grafana
#  - Should access each UI through reverse proxies
#  - Configuration directories and files don't all get right owners, groups and permissions
---
- hosts: all

  roles:
    - williamyeh.prometheus
    - ansiblebit.grafana

  vars:
    prometheus_components:
      - prometheus
      - alertmanager
    prometheus_conf_main: prometheus/prometheus.yml
    prometheus_alertmanager_conf: prometheus/alertmanager.yml
    grafana_admin_password: "password"
    grafana_conf_data: |
      app_mode = development

      [paths]
      data = {{ grafana_dir_data }}
      logs = {{ grafana_dir_log }}
      plugins = {{ grafana_dir_plugins }}

      [server]
      protocol = http
      http_port = {{ grafana_http_port }}

      [database]
      type = {{ grafana_database.type }}
      host = {{ grafana_database.host }}
      name = {{ grafana_database.name }}
      user = {{ grafana_database.user }}
      password = {{ grafana_database.password }}
      path = {{ grafana_database.path }}

      [session]

      [analytics]
      check_for_updates = true

      [security]
      admin_user = {{ grafana_admin_user }}
      admin_password = {{ grafana_admin_password }}

      [snapshots]

      [users]

      [auth.anonymous]

      [auth.github]

      [auth.google]

      [auth.proxy]

      [auth.basic]

      [auth.ldap]

      [smtp]

      [emails]

      [log]
      mode = file
      level = Info

      [log.console]

      [log.file]

      [event_publisher]

      [dashboards.json]
      enabled = true
      path = /var/lib/grafana/dashboards

  tasks:
    - name: "remove Grafana install detritus"
      file:
        path: "{{item}}"
        state: absent
      with_items:
        - grafana_dir_conf
        - grafana_dir_data
        - grafana_dir_home
        - grafana_dir_log
        - grafana_dir_plugins

    - name: "check if Prometheus data source set up"
      uri:
        url: http://localhost:3000/api/datasources/name/Prometheus
        user: "{{grafana_admin_user}}"
        password: "{{grafana_admin_password}}"
        force_basic_auth: yes
      register: grafana_prometheus
      failed_when: false
      changed_when: false

    - name: "enable Prometheus Datasource"
      uri:
        url: http://localhost:3000/api/datasources
        method: POST
        user: "{{grafana_admin_user}}"
        password: "{{grafana_admin_password}}"
        body:
          name: "Prometheus"
          type: "prometheus"
          url: "http://localhost:9090"
          access: "proxy"
          isDefault: true
        force_basic_auth: yes
        status_code: 200
        body_format: json
      when: grafana_prometheus.status == 404

    - name: "ensure web server packages are installed"
      apt:
        name: "{{item}}"
        state: latest
        update_cache: yes
      with_items:
        - nginx
        - uwsgi
        - uwsgi-plugin-python

    - name: "ensure default configuration files absent"
      file:
        path: "{{item}}"
        state: absent
      with_items:
        - /etc/nginx/sites-available/default
        - /etc/nginx/sites-enabled/default

    - name: "create echo UWSGI parameters software dashboards directory"
      file:
        dest: /opt/echo-uwsgi-parameters
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: "deploy echo UWSGI parameters software"
      copy:
        src: echo-uwsgi-parameters/app.py
        dest: /opt/echo-uwsgi-parameters/app.py
        owner: root
        group: root
        mode: 0644

    - name: "deploy echo UWSGI parameters NGINX configuration"
      copy:
        src: echo-uwsgi-parameters/nginx.conf
        dest: /etc/nginx/sites-available/echo-uwsgi-parameters.conf
        owner: root
        group: root
        mode: 0644
      notify:
        - nginx reloaded

    - name: "enable echo UWSGI parameters NGINX configuration"
      file:
        src: /etc/nginx/sites-available/echo-uwsgi-parameters.conf
        dest: /etc/nginx/sites-enabled/echo-uwsgi-parameters.conf
        state: link
        force: yes

    - name: "deploy echo UWSGI parameters UWSGI configuration"
      copy:
        src: echo-uwsgi-parameters/uwsgi.ini
        dest: /etc/uwsgi/apps-available/echo-uwsgi-parameters.ini
        owner: root
        group: root
        mode: 0644
      notify:
        - uwsgi reloaded

    - name: "enable echo UWSGI parameters UWSGI configuration"
      file:
        src: /etc/uwsgi/apps-available/echo-uwsgi-parameters.ini
        dest: /etc/uwsgi/apps-enabled/echo-uwsgi-parameters.ini
        state: link
        force: yes

    - name: "add NGINX extras to enable Prometheus plugin"
      apt:
        name: "{{item}}"
        state: latest
        update_cache: yes
      with_items:
        - nginx-extras

    - name: "get NGINX Prometheus metrics plugin"
      git:
        repo: "https://github.com/knyar/nginx-lua-prometheus.git"
        dest: /opt/nginx-lua-prometheus

    - name: "deploy Prometheus metrics NGINX configuration"
      copy:
        src: prometheus/metrics.nginx.conf
        dest: /etc/nginx/sites-available/prometheus-metrics.conf
        owner: root
        group: root
        mode: 0644
      notify:
        - nginx reloaded

    - name: "enable Prometheus metrics NGINX configuration"
      file:
        src: /etc/nginx/sites-available/prometheus-metrics.conf
        dest: /etc/nginx/sites-enabled/prometheus-metrics.conf
        state: link
        force: yes

    - name: "create Grafana dashboards directory"
      file:
        dest: /var/lib/grafana/dashboards
        state: directory
        owner: grafana
        group: grafana
        mode: 0755

    - name: "deploy Grafana dashboard configuration files"
      copy:
        src: "{{ item }}"
        dest: /var/lib/grafana/dashboards/
        owner: grafana
        group: grafana
        mode: 0644
      with_fileglob:
        "grafana/dashboards/*.json"
      notify:
        - restart grafana

  handlers:
    - name: "nginx reloaded"
      service:
        name: nginx
        state: reloaded

    - name: "uwsgi reloaded"
      service:
        name: uwsgi
        state: restarted
...
